name: Update Version

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Name of branch'
        required: true
        default: 'master'
      new_version:
        description: 'New version (e.g., 1.2.3)'
        required: true
        default: ''

jobs:
  update-version:
    runs-on: ubuntu-latest
    environment: DailyAnime

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}
          fetch-depth: 0
          token: ${{ secrets.CI_TOKEN }}

      - name: Read Current Version
        id: read_version
        run: |
          GRADLE_FILE='app/gradle.properties'
          echo "Reading file ${GRADLE_FILE}"
          
          if [ ! -f "${GRADLE_FILE}" ]; then
            echo "Error: ${GRADLE_FILE} not found"
            exit 1
          fi
          
          GRADLE_CONTENT=$(cat "${GRADLE_FILE}")
          echo "File content:"
          echo "${GRADLE_CONTENT}"
          
          # Extract version (with or without hash: 1.2.3 or 1.2.3-abc1234)
          FULL_VERSION=$(echo "${GRADLE_CONTENT}" | grep -oP 'version=\K\d+\.\d+\.\d+(-[a-f0-9]+)?')
          
          if [ -z "${FULL_VERSION}" ]; then
            echo "Error: Could not find version in ${GRADLE_FILE}"
            exit 1
          fi
          
          # Extract only numeric part (remove hash if present)
          CURRENT_VERSION=$(echo "${FULL_VERSION}" | cut -d'-' -f1)
          
          echo "current_version=${CURRENT_VERSION}" >> $GITHUB_OUTPUT
          echo "Full version in file: ${FULL_VERSION}"
          echo "Current version (numeric): ${CURRENT_VERSION}"

      - name: Determine New Version
        id: new_version
        run: |
          CURRENT_VERSION="${{ steps.read_version.outputs.current_version }}"
          INPUT_VERSION="${{ github.event.inputs.new_version }}"
          
          if [ -z "${INPUT_VERSION}" ]; then
            echo "Error: New version is required"
            exit 1
          fi
          
          NEW_VERSION="${INPUT_VERSION}"
          echo "New version provided: ${NEW_VERSION}"
          
          # Validate version format
          if ! echo "${NEW_VERSION}" | grep -qP '^\d+\.\d+\.\d+$'; then
            echo "Error: Invalid version format. Expected format: X.Y.Z"
            exit 1
          fi
          
          # Check if new version is different from current
          if [ "${NEW_VERSION}" = "${CURRENT_VERSION}" ]; then
            echo "Error: New version (${NEW_VERSION}) is the same as current version (${CURRENT_VERSION})"
            exit 1
          fi
          
          # Parse versions
          IFS='.' read -r CURRENT_MAJOR CURRENT_MINOR CURRENT_PATCH <<< "${CURRENT_VERSION}"
          IFS='.' read -r NEW_MAJOR NEW_MINOR NEW_PATCH <<< "${NEW_VERSION}"
          
          # Compare versions
          echo "Comparing versions: ${CURRENT_VERSION} -> ${NEW_VERSION}"
          echo "Current: ${CURRENT_MAJOR}.${CURRENT_MINOR}.${CURRENT_PATCH}"
          echo "New: ${NEW_MAJOR}.${NEW_MINOR}.${NEW_PATCH}"
          
          VERSION_IS_HIGHER=false
          
          if [ "${NEW_MAJOR}" -gt "${CURRENT_MAJOR}" ]; then
            VERSION_IS_HIGHER=true
          elif [ "${NEW_MAJOR}" -eq "${CURRENT_MAJOR}" ]; then
            if [ "${NEW_MINOR}" -gt "${CURRENT_MINOR}" ]; then
              VERSION_IS_HIGHER=true
            elif [ "${NEW_MINOR}" -eq "${CURRENT_MINOR}" ]; then
              if [ "${NEW_PATCH}" -gt "${CURRENT_PATCH}" ]; then
                VERSION_IS_HIGHER=true
              fi
            fi
          fi
          
          if [ "${VERSION_IS_HIGHER}" = "false" ]; then
            echo "Error: New version (${NEW_VERSION}) must be higher than current version (${CURRENT_VERSION})"
            exit 1
          fi
          
          echo "âœ“ Version check passed: ${NEW_VERSION} > ${CURRENT_VERSION}"
          echo "new_version=${NEW_VERSION}" >> $GITHUB_OUTPUT
          echo "Version to set: ${NEW_VERSION}"

      - name: Update Version in gradle.properties
        run: |
          GRADLE_FILE='app/gradle.properties'
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          
          echo "Updating version to ${NEW_VERSION}"
          # Remove old version (with or without hash)
          sed -i "s/version=[0-9]\+\.[0-9]\+\.[0-9]\+\(-[a-f0-9]\+\)\?/version=${NEW_VERSION}/" "${GRADLE_FILE}"
          
          echo "Updated content:"
          cat "${GRADLE_FILE}"

      - name: Configure Git
        run: |
          git config user.name "Github Actions"
          git config user.email "githubactions@dezdeqness.com"

      - name: Commit and Push Changes
        run: |
          NEW_VERSION="${{ steps.new_version.outputs.new_version }}"
          BRANCH="${{ github.event.inputs.branch }}"
          GRADLE_FILE='app/gradle.properties'
          
          git add app/gradle.properties
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "[CI] Update version to ${NEW_VERSION}"
          
          # Get commit hash
          LATEST_HASH=$(git rev-parse HEAD)
          SHORT_HASH=$(git rev-parse --short=7 HEAD)
          VERSION_WITH_HASH="${NEW_VERSION}-${SHORT_HASH}"
          
          echo "Latest commit hash: ${LATEST_HASH}"
          echo "Short commit hash: ${SHORT_HASH}"
          echo "Updating version to: ${VERSION_WITH_HASH}"
          
          # Update version with commit hash
          sed -i "s/version=${NEW_VERSION}/version=${VERSION_WITH_HASH}/" "${GRADLE_FILE}"
          
          git add app/gradle.properties
          git commit -m "[CI] Add commit hash to version ${VERSION_WITH_HASH}"
          
          BRANCH_NAME="${NEW_VERSION}-${LATEST_HASH}"
          echo "Creating temporary branch: ${BRANCH_NAME}"
          
          git checkout -b "${BRANCH_NAME}"
          git checkout "${BRANCH}"
          git reset --hard "origin/${BRANCH}"
          git rebase "${BRANCH_NAME}"
          
          echo "Pushing changes to ${BRANCH}"
          git push origin "${BRANCH}"
          
          echo "Cleaning up temporary branch"
          git branch -D "${BRANCH_NAME}"
