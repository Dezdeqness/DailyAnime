name: Release Tag

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'Enter the release message (optional)'
        required: false
        default: ''

jobs:
  create-tag:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read Version from gradle.properties
        id: read_version
        run: |
          GRADLE_FILE='app/gradle.properties'
          echo "Reading version from ${GRADLE_FILE}"
          
          if [ ! -f "${GRADLE_FILE}" ]; then
            echo "Error: ${GRADLE_FILE} not found"
            exit 1
          fi
          
          FULL_VERSION=$(cat "${GRADLE_FILE}" | grep -oP 'version=\K\d+\.\d+\.\d+(-[a-f0-9]+)?')
          
          if [ -z "${FULL_VERSION}" ]; then
            echo "Error: Could not find version in ${GRADLE_FILE}"
            exit 1
          fi
          
          VERSION=$(echo "${FULL_VERSION}" | cut -d'-' -f1)
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Full version in file: ${FULL_VERSION}"
          echo "Version for tag: ${VERSION}"

      - name: Configure Git user
        run: |
          git config user.name "Github action"
          git config user.email "githubactions@dezdeqness.com"

      - name: Set remote with release token
        run: |
          git remote set-url origin "https://x-access-token:${{ secrets.CI_TOKEN }}@github.com/Dezdeqness/DailyAnime.git"

      - name: Create and push tag
        run: |
          VERSION="${{ steps.read_version.outputs.version }}"
          INPUT_MESSAGE="${{ github.event.inputs.message }}"
          TAG="v${VERSION}"
          
          # Use custom message or default
          if [ -z "${INPUT_MESSAGE}" ]; then
            MESSAGE="Release ${VERSION}"
          else
            MESSAGE="${INPUT_MESSAGE}"
          fi

          echo "Creating tag ${TAG} with message: ${MESSAGE}"

          if git rev-parse "${TAG}" >/dev/null 2>&1; then
            echo "Tag ${TAG} already exists"
            exit 1
          fi

          git tag -a "${TAG}" -m "${MESSAGE}"
          git push origin "${TAG}"
